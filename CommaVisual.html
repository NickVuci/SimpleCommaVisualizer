<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Comma Visualizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0z4JcG7uj6C0qP+/Jr8ABST4e1RvXK6M7u2GRUOXFQ0kT8" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f8ff;
        }

        h1 {
            color: #333;
        }

        .container {
            margin: 20px auto;
            padding: 15px;
            max-width: 1000px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        input {
            padding: 8px;
            margin: 10px;
            font-size: 16px;
            width: 200px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background-color: #218838;
        }

        .stacked-visual {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            position: relative;
            width: 1000px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
        }

        .stationary-line {
            width: 2px;
            height: 180px;
            background-color: black;
            position: absolute;
            left: 0;
            top: 70px;
            z-index: 2;
        }

        .line {
            width: 1px;
            height: 80px;
            background-color: #007bff;
            position: absolute;
            bottom: 150px;
            z-index: 1;
        }

        .line2 {
            width: 1px;
            height: 80px;
            background-color: #dc3545;
            position: absolute;
            bottom: 50px;
            z-index: 1;
        }

        .results {
            margin-top: 20px;
            font-size: 18px;
        }

        .highlight {
            color: #dc3545;
            font-weight: bold;
        }
            .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .dark-mode .container {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        .dark-mode button {
            background-color: #444;
            color: #fff;
        }

        .dark-mode button:hover {
            background-color: #555;
        }

        .dark-mode .stationary-line {
            background-color: #ccc;
        }

        .dark-mode .line {
            background-color: #00bfff;
        }

        .dark-mode .line2 {
            background-color: #ff6347;
        }

        .explanation {
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            text-align: left;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .explanation {
            background-color: #2c2c2c;
        }
    </style>
</head>
<body>
    <button onclick="toggleDarkMode()" style="position: fixed; top: 10px; right: 10px;">Toggle Dark Mode</button>
    <h1>Simple Comma Visualizer</h1>
    <h2>Made by Nick Vuci</h2>
    <div class="explanation">
        <h3>What is a Musical Comma?</h3>
        <p>A <strong>musical comma</strong> is a small interval that arises from the discrepancy between different tuning systems in just intonation. It is the difference between two intervals that are theoretically the same but derived through different stacking of ratios. For example, stacking twelve perfect fifths (ratio 3/2) and comparing it to seven octaves (ratio 2/1) yields a small difference known as the Pythagorean comma.</p>
        <p>This tool allows you to explore such discrepancies by entering two different ratios, stacking them, and visually seeing where they align.</p>
    </div>

    <div class="container">
        <p>Enter two Just Intonation ratios and see where they align (difference < 25 cents):</p>
        <input type="text" id="ratio1" placeholder="Enter first ratio (e.g. 3/2)" />
        <input type="text" id="ratio2" placeholder="Enter second ratio (e.g. 2/1)" />
        <button onclick="startStacking()">Find the Comma</button>

        <div class="stack-container">
            <div class="stacked-visual" id="stacked-visual">
                <!-- Stationary black line as the starting point -->
                <div class="stationary-line"></div>
            </div>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        const centsThreshold = 25;  // Cents threshold to define a comma
        const maxWidth = 1000;  // Max width for the animation
        const animationDuration = 4;  // Total time for the final lines to appear in seconds

        function parseRatio(ratioString) {
            const [numerator, denominator] = ratioString.split("/").map(Number);
            return { numerator, denominator };
        }

        function ratioToCents(ratio) {
            return 1200 * Math.log2(ratio);  // Convert ratio to cents
        }

        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        function findComma(ratio1, ratio2, maxIterations = 100) {
            for (let n1 = 1; n1 <= maxIterations; n1++) {
                for (let n2 = 1; n2 <= maxIterations; n2++) {
                    const ratio1Stacked = {
                        numerator: Math.pow(ratio1.numerator, n1),
                        denominator: Math.pow(ratio1.denominator, n1)
                    };
                    const ratio2Stacked = {
                        numerator: Math.pow(ratio2.numerator, n2),
                        denominator: Math.pow(ratio2.denominator, n2)
                    };

                    const combinedNumerator = ratio1Stacked.numerator * ratio2Stacked.denominator;
                    const combinedDenominator = ratio1Stacked.denominator * ratio2Stacked.numerator;
                    const diffCents = Math.abs(ratioToCents(combinedNumerator / combinedDenominator));

                    if (diffCents < centsThreshold) {
                        const commonDivisor = gcd(combinedNumerator, combinedDenominator);
                        let simplifiedNumerator = combinedNumerator / commonDivisor;
                        let simplifiedDenominator = combinedDenominator / commonDivisor;

                        // Ensure the numerator is greater than the denominator
                        if (simplifiedNumerator < simplifiedDenominator) {
                            [simplifiedNumerator, simplifiedDenominator] = [simplifiedDenominator, simplifiedNumerator];
                        }

                        return {
                            n1,
                            n2,
                            diffCents: diffCents.toFixed(2),
                            commaRatio: `${simplifiedNumerator}/${simplifiedDenominator}`
                        };
                    }
                }
            }
            return null;
        }

        let isAnimating = false;

        function startStacking() {
            if (isAnimating) {
                return;
            }
            isAnimating = true;
            const ratio1String = document.getElementById("ratio1").value;
            const ratio2String = document.getElementById("ratio2").value;

            if (!ratio1String || !ratio2String) {
                document.getElementById("results").innerHTML = "<p class='highlight'>Please enter two valid ratios!</p>";
                isAnimating = false;
                return;
            }

            const ratio1 = parseRatio(ratio1String);
            const ratio2 = parseRatio(ratio2String);

            // Find where the comma is
            const commaData = findComma(ratio1, ratio2);

            if (commaData === null) {
                document.getElementById("results").innerHTML = `<p class='highlight'>No comma found within 100 iterations for both ratios.</p>`;
                isAnimating = false;
                return;
            }

            const { n1, n2, diffCents, commaRatio } = commaData;

            // Clear previous visualization
            const visualContainer = document.getElementById("stacked-visual");
            visualContainer.innerHTML = ''; 

            // Add the stationary black line
            const stationaryLine = document.createElement("div");
            stationaryLine.classList.add("stationary-line");
            visualContainer.appendChild(stationaryLine);

            const totalLines = Math.max(n1, n2);
            const delayStep1 = (animationDuration / n1) * 1000;  // Delay for first ratio's lines
            const delayStep2 = (animationDuration / n2) * 1000;  // Delay for second ratio's lines

            for (let i = 1; i <= totalLines; i++) {
                // First ratio (blue)
                if (i <= n1) {
                    const line1 = document.createElement("div");
                    line1.classList.add("line");
                    const leftPosition = (Math.log2(Math.pow(ratio1.numerator / ratio1.denominator, i)) / Math.log2(Math.pow(ratio1.numerator / ratio1.denominator, n1))) * maxWidth;
                    line1.style.left = `${leftPosition}px`;

                    // Add the delay for appearance
                    setTimeout(() => {
                        visualContainer.appendChild(line1);
                        if (i === totalLines) {
                            isAnimating = false;
                        }
                    }, i * delayStep1);
                }

                // Second ratio (red)
                if (i <= n2) {
                    const line2 = document.createElement("div");
                    line2.classList.add("line2");
                    const leftPosition2 = (Math.log2(Math.pow(ratio2.numerator / ratio2.denominator, i)) / Math.log2(Math.pow(ratio2.numerator / ratio2.denominator, n2))) * maxWidth;
                    line2.style.left = `${leftPosition2}px`;

                    // Add the delay for appearance
                    setTimeout(() => {
                        visualContainer.appendChild(line2);
                        if (i === totalLines) {
                            isAnimating = false;
                        }
                    }, i * delayStep2);
                }
            }

            // Display the results
            document.getElementById("results").innerHTML = `
                <p>The comma was found after stacking ratio <strong>${ratio1String}</strong> <strong>${n1}</strong> times and ratio <strong>${ratio2String}</strong> <strong>${n2}</strong> times.</p>
                <p>The difference at that point is <strong>${diffCents}</strong> cents, which equals the ratio <strong>${commaRatio}</strong>.</p>`;
        }

        function checkAnimationComplete(n1, n2, i) {
            if (i === Math.max(n1, n2)) {
                isAnimating = false;
            }
        }
    </script>
    <script>
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }
    </script>
</body>
</html>